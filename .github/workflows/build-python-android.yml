# GitHub Actions: Cross-compile CPython 3.8 for Android (Termux)
# Produces tarballs with the installed DESTDIR for each architecture.
name: Build Python 3.8 for Termux (Android)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [aarch64, armv7]
    env:
      PYTHON_VERSION: 3.8.16
      NDK_VERSION: r21e
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install host packages
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget unzip ccache pkg-config \
            zlib1g-dev libssl-dev libbz2-dev libreadline-dev libsqlite3-dev \
            libncurses5-dev libffi-dev liblzma-dev

      - name: Download Android NDK
        run: |
          NDK_VER=${{ env.NDK_VERSION }}
          NDK_ZIP="android-ndk-${NDK_VER}-linux-x86_64.zip"
          wget -q "https://dl.google.com/android/repository/${NDK_ZIP}" -O ndk.zip
          unzip -q ndk.zip -d $HOME/android-ndk
          # expose the concrete path for downstream steps
          NDK_PATH="$HOME/android-ndk/android-ndk-${NDK_VER}"
          echo "NDK_PATH=${NDK_PATH}" >> $GITHUB_ENV
          echo "NDK=${NDK_PATH}" > ndkpath.txt

      - name: Configure toolchain environment
        run: |
          NDK=${NDK_PATH:-$(cat ndkpath.txt)}
          # Set arch-specific toolchain variables and API level
          if [ "${{ matrix.arch }}" = "aarch64" ]; then
            API=21
            TARGET=aarch64-linux-android
            HOST_TRIPLE=aarch64-linux-android
          else
            API=16
            # clang driver for armeabi-v7a uses the 'armv7a-linux-androideabi' prefix
            TARGET=armv7a-linux-androideabi
            HOST_TRIPLE=armv7a-linux-androideabi
          fi
          SYSROOT="$NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          PATH_ADD="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin"
          echo "API=${API}" >> $GITHUB_ENV
          echo "TARGET=${TARGET}" >> $GITHUB_ENV
          echo "HOST_TRIPLE=${HOST_TRIPLE}" >> $GITHUB_ENV
          echo "SYSROOT=${SYSROOT}" >> $GITHUB_ENV
          echo "PATH=${PATH_ADD}:$PATH" >> $GITHUB_ENV
          # Use clang driver wrapper names provided by the NDK
          echo "CC=${TARGET}${API}-clang" >> $GITHUB_ENV
          echo "CXX=${TARGET}${API}-clang++" >> $GITHUB_ENV
          echo "AR=llvm-ar" >> $GITHUB_ENV
          echo "RANLIB=llvm-ranlib" >> $GITHUB_ENV

      - name: Download CPython source
        run: |
          PY_VER=${{ env.PYTHON_VERSION }}
          wget -q "https://www.python.org/ftp/python/${PY_VER}/Python-${PY_VER}.tgz"
          tar xf "Python-${PY_VER}.tgz"

      - name: Configure CPython for cross-compile
        working-directory: "Python-${{ env.PYTHON_VERSION }}"
        env:
          # GITHUB_ENV set earlier makes CC/CXX/.. available as environment vars here
          CC: ${{ env.CC }}
          CXX: ${{ env.CXX }}
          AR: ${{ env.AR }}
          RANLIB: ${{ env.RANLIB }}
          SYSROOT: ${{ env.SYSROOT }}
          API: ${{ env.API }}
          TARGET: ${{ env.TARGET }}
          HOST_TRIPLE: ${{ env.HOST_TRIPLE }}
        run: |
          set -euo pipefail
          # Export toolchain variables for configure/make
          export CC="${CC}"
          export CXX="${CXX}"
          export AR="${AR}"
          export RANLIB="${RANLIB}"
          export CFLAGS="--sysroot=${SYSROOT} -D__ANDROID_API__=${API} -O2 -fPIC"
          export LDFLAGS="--sysroot=${SYSROOT} -Wl,--no-undefined"
          # When cross-compiling, skip configure tests that try to run target executables.
          export ac_cv_file__dev_ptmx=yes
          export ac_cv_file__dev_ptc=no
          export ac_cv_have_long_long=yes
          # Configure CPython: build host is the runner (x86_64-pc-linux-gnu)
          ./configure \
            --host="${HOST_TRIPLE}" \
            --build=x86_64-pc-linux-gnu \
            --prefix=/usr \
            --enable-shared \
            --with-system-ffi \
            --without-ensurepip

      - name: Build and install (cross)
        working-directory: "Python-${{ env.PYTHON_VERSION }}"
        env:
          CC: ${{ env.CC }}
          CXX: ${{ env.CXX }}
        run: |
          set -euo pipefail
          make -j$(nproc)
          # Install into DESTDIR under the source tree for packaging
          make install DESTDIR="$PWD/install-${{ matrix.arch }}"

      - name: Package install tree
        working-directory: "Python-${{ env.PYTHON_VERSION }}"
        run: |
          set -euo pipefail
          TARNAME="../python-${{ env.PYTHON_VERSION }}-${{ matrix.arch }}.tar.gz"
          tar czf "${TARNAME}" "install-${{ matrix.arch }}"
          ls -lh "${TARNAME}"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-${{ env.PYTHON_VERSION }}-${{ matrix.arch }}
          path: python-${{ env.PYTHON_VERSION }}-${{ matrix.arch }}.tar.gz
