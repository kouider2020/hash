name: Build LIEF Termux ARM64 Wheel

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-termux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install QEMU user static
        run: |
          sudo apt update
          sudo apt install -y qemu-user-static

      - name: Enable ARM64 emulation
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Build LIEF inside Termux (ARM64)
        run: |
          docker run --rm -t \
            --platform linux/arm64 \
            termux/termux-docker:aarch64 \
            bash -lc "
              set -e

              pkg upgrade -y
              pkg install -y \
                python \
                python-dev \
                clang \
                cmake \
                ninja \
                make \
                git

              python -m pip install --upgrade pip build wheel setuptools

              git clone https://github.com/lief-project/LIEF.git
              cd LIEF

              mkdir build && cd build
              cmake .. \
                -DLIEF_PYTHON_API=ON \
                -DCMAKE_C_COMPILER=clang \
                -DCMAKE_CXX_COMPILER=clang++ \
                -DPython3_EXECUTABLE=\$(which python)

              ninja

              cd ../api/python
              python -m build --wheel
            "

      - name: Upload Termux wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: lief-termux-aarch64
          path: |
            **/LIEF/api/python/dist/*.whl
