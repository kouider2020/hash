name: Build LIEF ARM64 Wheel

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-lief-arm64:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build g++ make \
            qemu-user-static binfmt-support crossbuild-essential-arm64 \
            python3-dev python3.11-dev python3-pip

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build wheel for aarch64
        run: |
          git clone https://github.com/lief-project/LIEF.git
          cd LIEF
          mkdir build && cd build
          cmake .. \
            -DLIEF_PYTHON_API=ON \
            -DPYTHON_EXECUTABLE=$(which python3) \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DPython_INCLUDE_DIR=$(python3 -c "import sysconfig; print(sysconfig.get_paths()['include'])") \
            -DPython_LIBRARY=$(python3 -c "import sysconfig; print(sysconfig.get_config_var('LIBDIR'))")/libpython3.11.so
          make -j$(nproc)
          cd api/python
          python3 setup.py bdist_wheel

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: lief-arm64-wheel
          path: LIEF/build/api/python/dist/*.whl
